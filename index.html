<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Status Monitor</title>
	<style>
		body {
			font-family: 'Inter', sans-serif;
			background-color: #0d0d0d;
			color: #fff;
			margin: 0;
			padding: 0;
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
		}

		.container {
			width: 90%;
			max-width: 50rem;
		}

		h1 {
			text-align: center;
			font-size: 2rem;
			font-weight: 700;
			margin-bottom: 2rem;
			color: #00e676;
		}

		.status-card {
			background: #141414;
			border: 1px solid #222;
			border-radius: 0.75rem;
			padding: 1.5rem;
			margin-bottom: 1.25rem;
		}

		.status-name {
			font-size: 1.5rem;
			font-weight: 700;
			margin-bottom: 0.5rem;
			display: inline-block;
			text-decoration: none;
			transition: color 0.3s ease;
		}

		.status {
			font-size: 1.25rem;
			font-weight: 500;
			margin-bottom: 0.5rem;
		}

		.status-footer {
			font-size: 0.875rem;
			color: #aaa;
		}

		.footer {
			text-align: center;
			font-size: 0.875rem;
			color: #666;
			margin-top: 2rem;
		}
	</style>
</head>
<body>
<div class="container">
	<div id="status-container"></div>
	<div class="footer" id="refresh-footer"></div>
</div>

<script src="https://unpkg.com/openpgp@6.2.2/dist/openpgp.min.js"></script>
<script>
const statusModules = [
	{
		name: 'Cock.li',
		url: 'https://cock.li',
		updateRate: 60,
		statusLogic: async () => {
			const main = await proxyFetch("https://cock.li");
			if (main.error) return { color: '#ff0e00', message: main.message };

			const parser = new DOMParser();
			const doc = parser.parseFromString(main.text, 'text/html');
			const alertText = doc.body.innerText;

			let baseStatus = { color: '#00e676', message: 'Online' };
			if (alertText.includes('RED ALERT')) baseStatus = { color: '#ff0e00', message: 'RED ALERT' };
			else if (alertText.includes('ORANGE ALERT')) baseStatus = { color: '#ff6c00', message: 'ORANGE ALERT' };

			const canary = await proxyFetch("https://cock.li/canary.asc.txt");
			if (canary.error) return { color: '#ff0e00', message: canary.message };

			try {
				const message = await openpgp.readCleartextMessage({ cleartextMessage: canary.text });
				const publicKeyArmored = canary.text.match(/-----BEGIN PGP PUBLIC KEY BLOCK-----[^]+-----END PGP PUBLIC KEY BLOCK-----/)[0];
				const publicKey = await openpgp.readKey({ armoredKey: publicKeyArmored });
				const verificationResult = await openpgp.verify({ message, verificationKeys: publicKey });
				const { verified } = verificationResult.signatures[0];
				await verified;
			} catch (err) {
				return { color: '#ff0e00', message: `Canary PGP verification failed: ${err.message}` };
			}

			const dateMatch = canary.text.match(/The current datetime:\s*(.+UTC)/);
			if (!dateMatch) return { color: '#ff0e00', message: 'Canary: no datetime found' };

			const canaryDate = new Date(dateMatch[1].replace(" UTC","Z"));
			const diffHours = Math.abs(new Date() - canaryDate) / (1000 * 60 * 60);
			if (diffHours > 96) return { color: '#ff0e00', message: `Canary too old (>96h), last: ${canaryDate.toUTCString()}` };

			return baseStatus;
		}
	}
];

async function proxyFetch(url, timeout = 10000) {
    const proxies = [
        u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
        u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`
    ];

    let lastError;
    for (let getProxy of proxies) {
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const resp = await fetch(getProxy(url), { signal: controller.signal });
            clearTimeout(id);
            if (resp.ok) return { error: false, text: await resp.text() };
            lastError = `Fetch error: ${resp.status}`;
        } catch (err) {
            lastError = `Fetch error: ${err.message}`;
        }
    }

    return { error: true, message: lastError };
}

function createStatusCards() {
	const container = document.getElementById('status-container');
	container.innerHTML = '';
	statusModules.forEach(module => {
		const card = document.createElement('div');
		card.id = `status-${module.name}`;
		card.className = 'status-card';
		card.innerHTML = `
			<a href="${module.url || '#'}" target="_blank" class="status-name" style="color:#00e676;">${module.name}</a>
			<div class="status" style="color:#00e676;">Loading...</div>
			<div class="status-footer">Loading...</div>
		`;
		container.appendChild(card);
	});
}

async function updateStatus(module) {
	try {
		const { color, message } = await module.statusLogic();

		const card = document.getElementById(`status-${module.name}`);
		card.querySelector('.status-name').style.color = color;
		card.querySelector('.status').style.color = color;
		card.querySelector('.status').innerHTML = `<a href="${module.url || '#'}" target="_blank" style="color:${color};text-decoration:none;">${message}</a>`;
		card.querySelector('.status-footer').textContent = `Updated at ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
	} catch (err) {
		const card = document.getElementById(`status-${module.name}`);
		card.querySelector('.status-name').style.color = '#ff0e00';
		card.querySelector('.status').style.color = '#ff0e00';
		card.querySelector('.status').innerHTML = `<a href="${module.url || '#'}" target="_blank" style="color:#ff0e00;text-decoration:none;">Error: ${err.message}</a>`;
		card.querySelector('.status-footer').textContent = `Updated at ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
	}
}

function updateStatusForAllModules() {
	statusModules.forEach(module => updateStatus(module));
}

function setupFooter() {
	const footer = document.getElementById('refresh-footer');
	const isMobile = /Mobi|Android/i.test(navigator.userAgent);
	footer.textContent = isMobile ? 'Tap to refresh' : 'Press F5 to refresh';
	footer.style.cursor = 'pointer';
	footer.addEventListener('click', () => updateStatusForAllModules());
}

setupFooter();
document.addEventListener('keydown', e => {
	if (e.key === 'F5') {
		e.preventDefault();
		updateStatusForAllModules();
	}
});

createStatusCards();
updateStatusForAllModules();
statusModules.forEach(module => {
	setInterval(() => updateStatus(module), module.updateRate * 1000);
});
</script>
</body>
</html>
