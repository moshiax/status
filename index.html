<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Status Monitor</title>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap">
	<style>
		body {
			font-family: 'Inter', sans-serif;
			background-color: #0d0d0d;
			color: #fff;
			margin: 0;
			padding: 0;
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
		}

		.container {
			width: 90%;
			max-width: 50rem;
		}

		h1 {
			text-align: center;
			font-size: 2rem;
			font-weight: 700;
			margin-bottom: 2rem;
			color: #00e676;
		}

		.status-card {
			background: #141414;
			border: 1px solid #222;
			border-radius: 0.75rem;
			padding: 1.5rem;
			margin-bottom: 1.25rem;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
			transition: box-shadow 0.2s ease;
		}

		.status-card:hover {
			box-shadow: 0 6px 25px rgba(0, 0, 0, 0.6);
		}

		.status-name {
			font-size: 1.5rem;
			font-weight: 700;
			margin-bottom: 0.5rem;
			display: inline-block;
			text-decoration: none;
			transition: color 0.3s ease;
		}

		.status {
			font-size: 1.25rem;
			font-weight: 500;
			margin-bottom: 0.5rem;
		}

		.status-footer {
			font-size: 0.875rem;
			color: #aaa;
		}

		.footer {
			text-align: center;
			font-size: 0.875rem;
			color: #666;
			margin-top: 2rem;
		}

		.status-green {
			color: #00e676;
		}
		.status-red {
			color: #ff0e00;
		}
		.status-orange {
			color: #ff6c00;
		}
	</style>
</head>
<body>
<div class="container">
	<div id="status-container"></div>
	<div class="footer">Press F5 to refresh manually</div>
</div>

<script src="https://unpkg.com/openpgp@6.2.2/dist/openpgp.min.js"></script>
<script>
const statusModules = [
  {
    name: 'Cock.li',
    url: 'https://cock.li',
    updateRate: 60,
    statusLogic: async (content) => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(content, 'text/html');
      const alertText = doc.body.innerText;

      let baseStatus;
      if (alertText.includes('RED ALERT')) {
        baseStatus = { class: 'status-red', message: 'RED ALERT' };
      } else if (alertText.includes('ORANGE ALERT')) {
        baseStatus = { class: 'status-orange', message: 'ORANGE ALERT' };
      } else {
        baseStatus = { class: 'status-green', message: 'Online' };
      }

      try {
        const canaryResp = await fetch(
          "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent("https://cock.li/canary.asc.txt")
        );
        const canaryText = await canaryResp.text();

        const message = await openpgp.readCleartextMessage({ cleartextMessage: canaryText });
        const publicKeyArmored = canaryText.match(/-----BEGIN PGP PUBLIC KEY BLOCK-----[^]+-----END PGP PUBLIC KEY BLOCK-----/)[0];
        const publicKey = await openpgp.readKey({ armoredKey: publicKeyArmored });
        const verificationResult = await openpgp.verify({
          message,
          verificationKeys: publicKey
        });
        const { verified, keyID } = verificationResult.signatures[0];
        await verified; // throws if bad signature

        const dateMatch = canaryText.match(/The current datetime:\s*(.+UTC)/);
        if (!dateMatch) {
          return { class: 'status-red', message: 'Canary: no datetime found' };
        }
        const canaryDate = new Date(dateMatch[1].replace(" UTC","Z"));
        const now = new Date();
        const diffHours = Math.abs(now - canaryDate) / (1000 * 60 * 60);

        if (diffHours > 96) {
          return { class: 'status-red', message: `Canary too old (>96h), last: ${canaryDate.toUTCString()}` };
        }

        return baseStatus;
      } catch (e) {
        return { class: 'status-red', message: `Canary check failed: ${e.message}` };
      }
    }
  }
];


function createStatusCards() {
	const container = document.getElementById('status-container');
	container.innerHTML = '';
	statusModules.forEach(module => {
		const card = document.createElement('div');
		card.id = `status-${module.name}`;
		card.className = 'status-card';
		card.innerHTML = `
			<a href="${module.url}" target="_blank" class="status-name status-green">${module.name}</a>
			<div class="status status-green">Loading...</div>
			<div class="status-footer">Loading...</div>
		`;
		container.appendChild(card);
	});
}

async function updateStatus(module) {
	try {
		const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(module.url)}`;
		const response = await fetch(proxyUrl);
		const contents = await response.text();

		const { class: statusClass, message } = await module.statusLogic(contents);

		const card = document.getElementById(`status-${module.name}`);
		card.querySelector('.status-name').className = `status-name ${statusClass}`;
		card.querySelector('.status').className = `status ${statusClass}`;
		card.querySelector('.status').innerHTML = `<a href="${module.url}" target="_blank" class="${statusClass}" style="text-decoration:none;">${message}</a>`;
		card.querySelector('.status-footer').textContent = `Updated at ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
	} catch (err) {
		const card = document.getElementById(`status-${module.name}`);
		card.querySelector('.status-name').className = 'status-name status-red';
		card.querySelector('.status').className = 'status status-red';
		card.querySelector('.status').innerHTML = `<a href="${module.url}" target="_blank" class="status-red" style="text-decoration:none;">Error: ${err.message}</a>`;
		card.querySelector('.status-footer').textContent = `Updated at ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
	}
}

function updateStatusForAllModules() {
	statusModules.forEach(module => updateStatus(module));
}

document.addEventListener('keydown', e => {
	if (e.key === 'F5') {
		e.preventDefault();
		updateStatusForAllModules();
	}
});

createStatusCards();
updateStatusForAllModules();
statusModules.forEach(module => {
	setInterval(() => updateStatus(module), module.updateRate * 1000);
});
</script>
</body>
</html>